# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript
variables: 
  CURRENT_SHA : $(system.pullRequest.sourceCommitId)
  HAPPO_CONFIG_FILE : './config.js'

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- bash: |
    value=$(sed 's/....$//' <<< $(System.PullRequest.SourceRepositoryURI))/pull/$(System.PullRequest.PullRequestNumber)
    echo "##vso[task.setvariable variable=CHANGE_URL]$value"

- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: 'Install Node.js'

- script: |
    export PREVIOUS_SHA=git merge-base refs/heads/$(System.PullRequest.TargetBranch) refs/heads/$(System.PullRequest.SourceBranch)
    npm install
    npm run happo-ci
  displayName: 'yarn install and run happo'
